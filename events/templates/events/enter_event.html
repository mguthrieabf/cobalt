{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}
{% load crispy_forms_tags %}
{% load cobalt_tags %}

{% block header %}
<style>
  select{
      width: 100px;
      text-overflow: ellipsis;
  }

</style>
{% endblock %}

{% block content %}


<div class="container justify-content-center">
  <div class="row h-100 d-flex justify-content-center">
    <div class="card">
      <div class="card-header card-header-warning">
        <h2>{{ event.event_name }}</h2>
        <h3>{{ event.description|default_if_none:"" }}</h3>
        <h3>{{ congress.name }}</h3>
        <h4>{{ event_start.session_date|cobalt_nice_date }} {{ event_start.session_start|cobalt_time }}</h4>
      </div>
      <div class="card-body">
        <div class="container h-100 d-flex justify-content-center">
          <div class="card col-12">
            <div class="card-header card-header-primary">
              <h3>Entry</h3>
            </div>
            <div class="card-body table-responsive card-body-default">

{% for our_form_row in our_form %}
  {% include "utils/generic_user_search_body.html" with search_id=our_form_row.player_no %}
{% endfor %}

              <form method="POST">
                {% csrf_token %}

                {% if categories %}
                <label for="id_category">Category</label>
                <select class="selectpicker" data-style="btn btn-info" id="id_category" name="category">
                  {% for category in categories %}
                  <option value="{{ category.id }}">{{ category }}</option>
                  {% endfor %}
                </select>
                {% endif %}

              <table class="table-responsive">
                <thead class="text-warning">
                  <th style="text-align: center;">Players</th>
                  <th style="text-align: center;">Payment Method</th>
                  <th style="text-align: center;">You</th>
                  <th style="text-align: center;">Pending</th>
                </thead>
                <tbody style="overflow:hidden;">

                    <tr>
                      <td class="col text-center">
                        <div id="div_id_player0" class="form-group">
                          <select class="selectpicker" data-style="btn btn-info" title="Select" id="id_player0" name="player0">
                            <option value="{{ player0.id }}" selected>{{ player0.name }}</option>
                          </select>
                        </div>
                      </td>
                      <td class="col">
                        <select id="id_player0_payment" name="player0_payment" data-container="body" class="selectpicker payment-method" data-style="btn btn-danger">
                          {% for val,item in player0.payment_choices %}
                          <option value="{{ val }}">{{ item }}</option>
                          {% endfor %}
                        </select>
                      <td class="col">
                        <nobr>
                          {% if discount %}
                          <span class="myHover" data-toggle="tooltip" title="{{ description }}" data-delay="100" data-placement="bottom">
                            <i class="fas fa-tag"></i>
                          </span>
                          {% else %}
                          &nbsp;
                          {% endif %}
                          <input id="fee_0_now" class="pay_now" type="text" size="6" readonly value="{{ player0.entry_fee_you }}">
                        </nobr>
                      <td class="col">
                        <input id="fee_0_later" class="pay_later" type="text" size="6" readonly value="{{ player0.entry_fee_pending }}">
                    </tr>

{% for our_form_row in our_form %}
{% include "events/enter_event_sub.html" with row=our_form_row %}
{% endfor %}
                    <tr>
                      <td>
                      <td class="col" style="text-align: right; padding-right:18px;"><b>Total</b>
                      <td class="col" align="right">
                        <input id="total_now" type="text" size="6" readonly value="">
                      <td class="col">
                        <input id="total_later" type="text" size="6" readonly value="">
                    </tr>

                </tbody>
              </table>
              <br>
              {% if event.free_format_question %}
                <label for="id_category">{{ event.free_format_question }}</label>
                <input type="text" size="60" id="id_free_format_answer" name="free_format_answer">
                <br>
                <br>
              {% endif %}
              <div class="row">
                <div class="col text-center">
                  <button id="id_checkout" type="submit" name="now" class="btn btn-success cobalt-save" style="width:150px" disabled>Checkout Now</button>
                  <button id="id_cart" type="submit" name="cart" onclick="this.disabled=true,this.form.submit();" class="btn btn-success cobalt-save" style="width:150px" disabled>Add to Cart</button>
                </div>
              </div>
            </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block footer %}

<script src="{% static "assets/js/plugins/bootstrap-selectpicker.js" %}"></script>
<script src="{% static "assets/js/plugins/sweetalert2.js" %}"></script>
<script src="{% static "assets/js/plugins/jquery.cookie.1.4.1.min.js" %}"></script>
<!-- <script src="{% static "assets/js/cobalt-unsaved.js" %}"></script> -->
<script>

// include all of the generic searches for each player entry

  {% for our_form_row in our_form %}
    {% include 'utils/generic_user_search_footer.html' with search_id=our_form_row.player_no %}
  {% endfor %}

// callback from generic search if user is chosen
function cobaltMemberSearchOk(search_id) {

  // check if this member is already on this page
  var search_member_id = member_id[search_id];
  var already = false;
  $('.cobalt-playerN').each(function(i, obj) {
    if ($(this).val() == search_member_id){
      already = true;
    }
  });

  if (already == true) {
    swal.fire({
        title: "Already Added",
        html: member_name[search_id] + " is already in your team.",
        icon: "error",
        buttonsStyling: false
      })
  } else {

    // add option if not already there
    if ($('#id_player' + search_id + ' option[value=' + member_id[search_id] + ']').length==0) {
      // not found so add
      $("#id_player" + search_id).append('<option value="'+member_id[search_id]+'" selected="">'+member_name[search_id]+'</option>');
    } else {
      // already present - set as selected
      $("#id_player" + search_id).val(member_id[search_id]).selectpicker('refresh');
    }

// check on fees and payment methods

// for teams don't charge for players 5 and 6 (4 and 5 in computer counting)
    if (search_id<4){
      user_entry_fee(member_id[search_id], search_id);
      user_payment_method(member_id[search_id], search_id);
    }
  }
}

// if generic search is cancelled reset the player field
function cobaltMemberSearchCancel(search_id) {
  $("#id_player" + search_id).val('').selectpicker('refresh');
}

// re-do totals
function totals(){

// total_now
  var total_now = 0;
  $('.pay_now').each(function(){
    var val = parseFloat($(this).val());
    val = val || 0  // zero if NaN
    total_now += val;
  });

  if (total_now == 0){
    $("#total_now").val("");
  } else {
    $("#total_now").val(total_now.toFixed(2));
  }

// total_later
  var total_later = 0;
  $('.pay_later').each(function(){
      var val = parseFloat($(this).val());
      val = val || 0  // zero if NaN
      total_later += val;
  });

  if (total_later == 0){
    $("#total_later").val("");
  } else {
    $("#total_later").val(total_later.toFixed(2));
  }
}

// get entry fee for user
function user_entry_fee(user_id, search_id){
  console.log("Inside user_entry_fee");
  console.log("params are user_id: " + user_id + " search_id: " + search_id);
  $.get("{% url "events:fee_for_user_ajax" %}?event_id={{ event.id }}&user_id=" + user_id)
    .done(response => {
      msg = response['data']['message'];
      if (msg == 'Success') {
        if (response['data']['discount']>0) {
          $("#player" + search_id + "_discount_alert").html('<span class="myHover" data-toggle="tooltip" title="'
               + response['data']['description']
               + '" data-delay="100" data-placement="bottom"><i class="fas fa-tag"></i></span>');

          $(".myHover").tooltip();
      }
        $("#fee_" + search_id + "_now").val(response['data']['entry_fee']);
        $("#fee_" + search_id + "_later").val("");

    // enable payment type - must refresh selectpickers
        $("#id_player" + search_id + "_payment").prop("disabled", false);
        $('.selectpicker').selectpicker('refresh');
        totals();
      }
  });
}
// update payment method if team mates
function user_payment_method(user_id, search_id){
  console.log("Inside user_payment_method");
  console.log("params are user_id: " + user_id + " search_id: " + search_id);
$.get("{% url "events:payment_options_for_user_ajax" %}?event_id={{ event.id }}&entering_user_id={{ request.user.id }}&other_user_id=" + user_id)
  .done(response => {
    var msg = response['data']['message'];
// get pay amt
    var now_payment = $("#fee_" + search_id + "_now");
    var later_payment = $("#fee_" + search_id + "_later");
    var pay_amt = now_payment.val() || later_payment.val();

    if (msg == 'Allowed') {
      $("#id_player" + search_id + "_payment").prepend('<option value="their-system-dollars" selected="">Their {{ BRIDGE_CREDITS }}</option>');
      $("#id_player" + search_id + "_payment").prop("disabled", false);
      $("#id_player" + search_id + "_payment").val('their-system-dollars');
      later_payment.val(pay_amt);
      now_payment.val("");

    } else {

      $("#id_player" + search_id + "_payment option[value='their-system-dollars']").remove();
      $("#id_player" + search_id + "_payment").val('my-system-dollars');
      later_payment.val("");
      now_payment.val(pay_amt);

    }

    // refresh the fussy selectpickers
    $('.selectpicker').selectpicker('refresh');

    // update totals
    totals();
  });
}

// lets get ready to rumble!!!
$(document).ready(function(){

// calculate totals
  totals();

// show early discount etc msg but only once per congress
  {% if alert_msg %}

  var alert0 = "{{ alert_msg.0 }}";
  var alert0_cookie = alert0.replace(/ /g, "-");

  if (typeof $.cookie(alert0_cookie + '-{{ congress.id }}') === 'undefined') {
    $.cookie(alert0_cookie+ '-{{ congress.id }}', 'set', {
      expires: 10000,
      domain: '',
      path: ''
    });

    swal.fire({
        title: "{{ alert_msg.0 }}",
        html: "{{ alert_msg.1 }}",
        icon: "success",
        buttonsStyling: false
      })
  }

  {% endif %}

// init tooltips
  $(".myHover").tooltip();

// Handle member select
  previous={};
  previous_name={};

  // when player N identity changes get their entry fee and update table
  $('.cobalt-playerN').change(function(event) {

      var user_id = this.value;
      var search_id = event.target.id.slice(-1);
      var this_id = event.target.id;

  // check for search id=0
      if (user_id == 0){
        $('#cobalt_general_member_search' + search_id).modal('show');

      } else {

  // get entry fee and payment methods
        if (search_id<4){
          console.log("333 about to call user_entry_fee");
          console.log("Vars");
          console.log(user_id);
          console.log(search_id);
          user_entry_fee(user_id, search_id);
          user_payment_method(user_id, search_id);
        }
// remove from other lists
        if (user_id != {{ TBA_PLAYER }}) {
          $(".cobalt-playerN option[value='" + user_id + "']").each(function() {
            if ($(this).parent().attr('id') != this_id) {
              $(this).remove();
            }
          });
        }
      }

// if we had a previous value then add that back in to the other lists
// This took a while to work out - selectpicker creates a wrapper around
// the select and you get two matches back. Need to look at the first
// child and see if it is SELECT (real object).
      if (previous[this_id]) {
        $(".cobalt-playerN").each(function(){
            var realthis = $(this)[0];
            if (realthis.tagName == "SELECT"){
              $(this).append('<option value="' + previous[this_id] + '">' + previous_name[this_id] + '</option>');
            }
        });
      };
      $('.selectpicker').selectpicker('refresh');
      previous[this_id] = this.value;
      previous_name[this_id] = $('#' + this_id).find('option:selected').text();


// see if form is now complete
    var complete = 1;
    $(".cobalt-playerN").each(function(i, obj){
      if ($(this).val()>0) {
        complete+=1;
      }
    });
    if (complete=={{ min_entries }}){
      $("#id_checkout").prop("disabled", false);
      $("#id_cart").prop("disabled", false);
      $("#plus_4").show();
    }
  });

// when player payment method changes update totals
// id of trigger event is id_player(N)_payment
// we need to change
  $('.payment-method').on('change', function(event){
    var me = event.target.id;
    var parts = me.split("_");
    var player_no = parts[1].slice(-1);  // last char of word 2

    var now_payment = $("#fee_" + player_no + "_now");
    var later_payment = $("#fee_" + player_no + "_later");

  // one or other payment field will have a value
    var pay_amt = now_payment.val() || later_payment.val();

    var selection = $(this).val();
    if (selection == 'my-system-dollars') {
      now_payment.val(pay_amt);
      later_payment.val("");
    } else {
      now_payment.val("");
      later_payment.val(pay_amt);
    }
    totals();

  });

// for teams add row when plus sign clicked
  $('#plus_sign_4').click(function(event){
    event.preventDefault();
    $('#div_id_player4').show();
    $('#fee_4_now').show();
    $('#fee_4_later').show();
    $('#id_player4_paydiv').show();
    $('#plus_5').show();
    $('#plus_4').hide();
    return false;
  });

  $('#plus_sign_5').click(function(event){
    event.preventDefault();
    $('#div_id_player5').show();
    $('#fee_5_now').show();
    $('#fee_5_later').show();
    $('#id_player5_paydiv').show();
    $('#plus_5').hide();
    return false;
  });


});
</script>

{% endblock %}
