{% extends 'base.html' %}
{% load static %}
{% load cobalt_tags %}
{% load widget_tweaks %}
{% load crispy_forms_tags %}

{% block header %}
<style>
  .cobalt-left {
    text-align: left;
    padding-right: 20px;
  }

  .cobalt-table {
    margin: 0px auto;
  }
</style>
{% endblock %}
{% block content %}

<div class="container">
  <div class="row text-center">
    <div class="card">
      <div class="card-header card-header-warning">
        <h1>Edit Entry</h1>
        <h2>{{ event.event_name }} in {{ congress.name }}</h2>
      </div>
      <div class="card-body text-center mx-auto">

        <p class="display-4">Entry status is: <b>{{ event_entry.entry_status }}</b></p>

        <div class="form-check form-check-inline">
          <label class="form-check-label">
            <input class="form-check-input" type="checkbox" id="enable_edit">Edit Entry
            <span class="form-check-sign">
                <span class="check"></span>
            </span>
          </label>
        </div>

        <div class="container table-responsive">
        <div class="row table-responsive">
          <table class="table table-responsive table-hover" >
            <thead>
              <tr>
                <th></th>
                <th>Player</th>
                <th class="editable" style="display:none"></th>
                <th>Payment Method</th>
                <th>Entry Fee</th>
                <th>Status</th>
                {% if event_entry.entry_status != "Complete" %}
                <th class="editable" style="display:none">Action</th>
                {% endif %}
              </tr>
            </thead>
            <tbody>

          {% for event_entry_player in event_entry.evententryplayer_set.all %}
            {% include "utils/generic_user_search_body.html" with search_id=event_entry_player.id %}
            <tr>
              <td><a href="javascript:void(0)" onclick="
                                swal.fire({
                                          title: '{{ Details }}',
                                          showClass: {
                                            popup: 'animate__animated animate__fadeInDown'
                                          },
                                          hideClass: {
                                            popup: 'animate__animated animate__fadeOutUp'
                                          },
                                          html: '<table class=cobalt-table>\
                                                  <tr>\
                                                    <td class=cobalt-left>Player: </td>\
                                                    <td class=cobalt-left>{{ event_entry_player.player }}</td>\
                                                  </tr>\
                                                  <tr>\
                                                    <td class=cobalt-left>Payment Method: </td>\
                                                    <td class=cobalt-left>{{ event_entry_player.get_payment_type_display }}</td>\
                                                  </tr>\
                                                  <tr>\
                                                    <td class=cobalt-left>Entry Fee: </td>\
                                                    <td class=cobalt-left>{{ event_entry_player.entry_fee|cobalt_credits }}</td>\
                                                  </tr>\
                                                  <tr>\
                                                    <td class=cobalt-left>Paid: </td>\
                                                    <td class=cobalt-left>{{ event_entry_player.payment_received|cobalt_credits }}</td>\
                                                  </tr>\
                                                  <tr>\
                                                    <td class=cobalt-left>Payment Date: </td>\
                                                    <td class=cobalt-left>{{ event_entry_player.entry_complete_date|cobalt_nice_datetime|default_if_none:"" }}</td>\
                                                  </tr>\
                                                  <tr>\
                                                    <td class=cobalt-left>Payment By: </td>\
                                                    <td class=cobalt-left>{{ event_entry_player.paid_by }}</td>\
                                                  </tr>\
                                                  </table>',
                                          icon: 'info',
                                          confirmButtonColor: '#3085d6',
                                          cancelButtonColor: '#d33',
                                          confirmButtonText: 'Dismiss'
                                        })">
                  <i class="material-icons">info</i></a></td>
              <td class="px-0 py-1 mx-0 my-2">

                <div class="px-0 py-0 mx-0 my-0 text-center">
                  <img id="cobalt-pic-{{ event_entry_player.id }}" class="cobalt-rounded text-center px-0 py-0  mx-0 my-0" style="height: 60px; width: 60px;" src="/media/{{ event_entry_player.player.pic }}" />
                  <p class="px-0 py-0  mx-0 my-0" id="player-name-{{ event_entry_player.id }}">
                    {{ event_entry_player.player.full_name }}
                  </p>
                </div>

                </td>
              <td class="editable" style="display:none">
                <a class="cobalt_generic_member btn btn-sm btn-primary text-light" data-toggle="modal" id="unique_id" data-target="#cobalt_general_member_search{{ event_entry_player.id }}">Change Player</a>
              </td>
              <td style="white-space: nowrap;">{{ event_entry_player.get_payment_type_display }}</td>
              <td>{{ event_entry_player.entry_fee|cobalt_credits }}</td>
              <td>
                <div>

                  <div>
                {% if event_entry_player.payment_status == "Paid" %}
                  <span class="text-success"><i class="material-icons">check_circle</i></span>
                {% else %}
                  <span class="text-primary"><i class="material-icons">warning</i></span>
                {% endif %}
                  </div>
                  <div>
                {{ event_entry_player.payment_status }}
                  </div>
                </div>
              </td>

              {% if event_entry_player.payment_status != "Paid" %}
              <td class="editable" style="display:none">
                <button class="btn btn-sm btn-info">Pay Now</button>
              </td>
              {% else %}
                {% if event_entry.entry_status != "Complete" %}
              <td></td>
                {% endif %}
              {% endif %}

            </tr>
          {% endfor %}

            </tbody>
          </table>
          </div>
        </div>
        <button class="editable btn btn-primary text-left" style="display:none">Add Player to Team</button>
        <div class="text-center">
          <a href="{% url "events:delete_event_entry" event_entry_id=event_entry.id %}" class="btn btn-danger">Withdraw From Event!!!</a>
          <button class="btn btn-success">Exit</button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block footer %}
<script src="{% static "assets/js/plugins/sweetalert2.js" %}"></script>
<script>

  {% for event_entry_player in event_entry.evententryplayer_set.all %}
    {% include "utils/generic_user_search_footer.html" with search_id=event_entry_player.id %}
  {% endfor %}

  // edit player
function cobaltMemberSearchOk(search_id) {
  var member = member_id[search_id];
  var name = member_name[search_id];
  var pic = member_pic[search_id];

  // Check if player entered already

    $.getJSON("{% url "events:check_player_entry_ajax" %}" + "?member_id=" + member + "&event_id={{ event.id }}")
      .done(response => {

  // already entered
        if (response['message'] == "Already Entered"){
          swal.fire({
              title: "Error",
              html: name + " is already entered in this event",
              icon: "error",
              buttonsStyling: false
            })

        } else {

  // not entered so swap player - the search_id is the id of the player event entry
          $.getJSON("{% url "events:change_player_entry_ajax" %}" + "?member_id=" + member + "&player_event_entry=" + search_id)
            .done(response => {
              if (response['message'] == "Success"){
              // update page
                $("#cobalt-pic-" + search_id).attr("src", "/media/" + pic);
                $("#player-name-" + search_id).html(name);
                Swal.fire({
                  title: 'Player Changed',
                  html: 'Player successfully changed',
                });
              }
            });
        }

      })





}

$(document).ready(function() {

// show edit info if selected
$("#enable_edit").click(function(){
  $(".editable").each(function() {
    $(this).toggle(100);
//        $('#entrytable').bootstrapTable('refresh');
  });
});

});
</script>
{% endblock %}
