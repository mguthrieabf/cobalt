
{% extends 'base.html' %}

{% load widget_tweaks %}

{% block content %}
<div  class="container">
  <div class="row justify-content-center">
    <div class="card col-11 col-md-6">
      <div class="card-header card-header-primary">
        <h3 class="card-title">{{ GLOBAL_ORG }} Dollar Transfer</h3>
        <h5>Transfer funds online to another member</h5>
      </div>
      <h3>{{ msg }}</h3>
      <div class="card-body">
        <div class="container">
          <div id="cobalt-search" class="row justify-content-center">
            <div class="card col-11 col-md-9">
              <div class="card-header card-header-warning">
                <h4>Member Lookup</h4>
              </div>
              <div class="card-body">

                <div class="form-group">
                  <label for="lastname" class="bmd-label-floating">Last Name</label>
                  <input type="text" class="form-control dynamic-search" id="id_lastname" name="lastname" value="">
                </div>

                <div class="form-group">
                  <label for="" class="bmd-label-floating">First Name</label>
                  <input type="text" class="form-control dynamic-search" id="id_firstname" name="firstname" value="">
                </div>

              </div>
            </div>
          </div>
          <div id="cobalt-member">
          </div>
          <form action="member-transfer" method="post">
          {% csrf_token %}

            <div class="row justify-content-center">
              {{ form.transfer_to.errors }}
                <span id="search-results"></span>
            </div>

            <div id="cobalt-after" style="display: none;">

              <div class="row justify-content-center">
                {{ form.amount.errors }}
                <div class="form-group">
                  <label for="id_amount" class="bmd-label-floating">Amount $</label>
                  {% render_field form.amount class+="form-control" %}
                </div>
              </div>
              <div class="row justify-content-center">
                <div class="w-100"></div>
                <div class="form-group">
                  <label for="id_description" class="bmd-label-floating">Description (optional)</label>
                  {% render_field form.description class+="form-control" %}
                </div>
              </div>

            <div class="row justify-content-center">
              <div id="cobalt-hidden-member"></div>
             <input type="submit" value="Transfer" id="cobalt-button" class="btn btn-block col-11 col-md-5" disabled>
            </div>
          </div>
          </form>

        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block footer %}
<script>

// Dynamic search when input fields change

  jQuery(document).ready(function() {

    $("#id_amount").on('keyup', function() {
      if ($("#id_amount").val()>0){
        $("#cobalt-button").prop('disabled', false);
      } else {
        $("#cobalt-button").prop('disabled', true);
      }
    });

    const lastname = $("#id_lastname")
    const firstname = $("#id_firstname")
    const search_results = $('#search-results')
    const search_panel = $('#cobalt-search')
    const form_dets = $('#cobalt-after')
    const member_display = $('#cobalt-member')
    const member_search = '{% url "accounts:member_search_ajax" %}'
    const member_detail = '{% url "accounts:member_detail_ajax" %}'

    $(".dynamic-search").on('keyup', function(event){
      event.stopPropagation();
      event.stopImmediatePropagation();
      var ln = lastname.val();
      var fn = firstname.val();
      search_results.html("");
      if (ln.length + fn.length > 3) {
        $.getJSON(member_search + "?lastname=" + ln + "&firstname=" + fn)
            .done(response => {
              // update screen with results
                search_results.html(response['data']);
              // watch for user selecting member and change screen again
                $(".cobalt-names").change(function() {
                  $.getJSON(member_detail + "?member_id=" + $(this).val())
                    .done(response => {
                      search_panel.hide();
                      search_results.html("");
                      // show the member
                      member_display.html(response['data']);
                      // show amount, description and button
                      form_dets.show();
                      // hide member number on form
                      $("#cobalt-hidden-member").html("<input type='hidden' id='id_transfer_to' name='transfer_to' value='" + $(this).val() + "'>");
                    });
                 });
            })
      }
    });
  });

</script>

{% endblock %}
