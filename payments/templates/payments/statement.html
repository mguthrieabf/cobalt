{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block header %}
<link href="{% static "assets/css/bootstrap4-toggle.min.css" %}" rel="stylesheet">
<script src="{% static "assets/js/bootstrap4-toggle.min.js" %}"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.0.0/animate.min.css"/>
<style>
.cobalt-left {
  text-align: left;
  padding-right: 20px;
}

.cobalt-table {
  margin: 0px auto;
}
</style>
{% endblock %}

{% block content %}

<div class="">
  <div class="card">
    <div class="card-header card-header-warning">
      <h1>{{ GLOBAL_ORG }} {{ GLOBAL_CURRENCY_NAME}}s - {{ request.user.full_name }}</h1>
      <h3>{% if summary.IsActive %}{{club}}{% else %}Inactive - Used to play at {{club}}{% endif %}</h3>
      <h2>Balance: {{ GLOBAL_CURRENCY_SYMBOL }}{{ balance|intcomma }}</h2>

          <div class="float-left">

              <b>Auto Top Up</b>
              {% if auto_button %} ({{GLOBAL_CURRENCY_SYMBOL}}{{ request.user.auto_amount }}) {% endif %}
              <input id="auto-button" type="checkbox" data-toggle="toggle" data-onstyle="success" data-size="sm"
              {% if auto_button %} checked {% endif %}
               >
              {% if auto_button %}
                &nbsp;<a href="{% url "payments:setup_autotopup" %}">Update Card Details</a>
              {% endif %}
              <div id="console-event"></div>
          </div>

    </div>
    <div class="card-body table-responsive">
      <div class="container">
        <div class="row">
          <div class="col-6 col-md-6 col-lg-3 text-center">
            <a href="{% url 'payments:member_transfer' %}"<button class="text-center btn btn-dark btn-round" style="width: 170px">
              <i class="material-icons">people_alt</i>&nbsp;Pay A Friend
            </button>
            </a>
          </div>
          <div class="col-6 col-md-6 col-lg-3 text-center">
            <a href="{% url 'payments:manual_topup' %}"<button class="text-center btn btn-success btn-round" style="width: 170px">
              <i class="material-icons">attach_money</i>&nbsp;Top Up Balance
            </button>
            </a>
          </div>
          <div class="col-6 col-md-6 col-lg-3 text-center">
            <a href="{% url 'payments:statement_csv' %}"<button class="text-center btn btn-primary btn-round" style="width: 170px">
              <i class="material-icons">arrow_downward</i>&nbsp;Download as CSV
              </button>
            </a>
          </div>
          <div class="col-6 col-md-6 col-lg-3 text-center">
            <a href="{% url 'payments:statement_pdf' %}"<button class="text-center btn btn-info btn-round" style="width: 170px">
              <i class="material-icons">picture_as_pdf</i>&nbsp;Download as PDF
              </button>
          </a>
          </div>
        </div>

      </div>

      <hr>

      <table class="table table-hover">
        <thead class="text-info">
          <tr>
            <th></th>
            <th>Date</th>
            <th>Counterparty</th>
            <th>Type</th>
            <th>Description</th>
            <th class="text-right">In({{ GLOBAL_CURRENCY_SYMBOL }})</th>
            <th class="text-right">Out({{ GLOBAL_CURRENCY_SYMBOL }})</th>
            <th class="text-right">Balance({{ GLOBAL_CURRENCY_SYMBOL }})</th>
          </tr>
        </thead>
        <tbody>
          {% for event in events %}
            <tr>
              <td><a href="#" onclick="
                              swal.fire({
                                        title: '{{ event.type }}',
                                        showClass: {
                                          popup: 'animate__animated animate__fadeInDown'
                                        },
                                        hideClass: {
                                          popup: 'animate__animated animate__fadeOutUp'
                                        },
                                        html: '<table class=cobalt-table>\
                                                <tr>\
                                                  <td class=cobalt-left>Date: </td>\
                                                  <td class=cobalt-left>{{ event.created_date }}</td>\
                                                </tr>\
                                                <tr>\
                                                  <td class=cobalt-left>Description:</td>\
                                                  <td class=cobalt-left>{{ event.description }}</td>\
                                                </tr>\
                                                <tr>\
                                                  <td class=cobalt-left>Reference:</td>\
                                                  <td class=cobalt-left>{{ event.reference_no }}</td>\
                                                </tr>\
                                                <tr>\
                                                  <td class=cobalt-left>Counterparty:</td>\
                                                  <td class=cobalt-left>{{ event.other_member|default_if_none:"" }}\
                                                    {{ event.organisation|default_if_none:"" }}</td>\
                                                  </tr>\
                                                  <tr>\
                                                    <td class=cobalt-left>Amount:</td>\
                                                    <td class=cobalt-left>{{ event.amount|floatformat:2|intcomma }}</td>\
                                                  </tr>\
                                                </table>',
                                        icon: 'info',
                                        confirmButtonColor: '#3085d6',
                                        cancelButtonColor: '#d33',
                                        confirmButtonText: 'Dismiss'
                                      })">
                <i class="material-icons">info</i></a></td>
              <td>{{ event.created_date|date:"d M Y" }}</td>
              <td>{{ event.other_member|default_if_none:"" }}{{ event.organisation|default_if_none:"" }}</td>
              <td>{{ event.type }}</td>
              <td>
                {% if event.stripe_transaction.stripe_receipt_url %}
                    <a href="{{ event.stripe_transaction.stripe_receipt_url }}">

                      Payment from <img height="16px;" src="
                      {% if event.stripe_transaction.stripe_brand == "visa" %}
                        {% static 'assets/img/cards/visa-dark.png' %}
                      {% elif event.stripe_transaction.stripe_brand == "mastercard" %}
                        {% static 'assets/img/cards/mastercard-dark.png' %}
                      {% else %}
                        {% static 'assets/img/cards/default-dark.png' %}
                      {% endif %}
                      ">

                      ending {{ event.stripe_transaction.stripe_last4 }}
                    </a>
                {% else %}
                      {{ event.description }}
                {% endif %}
              </td>
              {% if event.amount >= 0 %}
                <td class="text-right">{{ event.amount|floatformat:2|intcomma }}</td>
                <td></td>
              {% else %}
                <td></td>
                <td class="text-right">{{ event.amount|floatformat:2|intcomma|slice:"1:" }}</td>
              {% endif %}
              <td class="text-right">{{ event.balance|floatformat:2|intcomma }}</td>

            </tr>
          {% endfor %}
        </tbody>
      </table>

      {% if events.has_other_pages %}
        <ul class="pagination">
          {% if events.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?page={{ events.previous_page_number }}">Previous</a>
            </li>
          {% else %}
            <li class="page-item disabled">
              <span class="page-link">Previous</span>
            </li>
          {% endif %}
          {% for i in events.paginator.page_range %}
            {% if events.number == i %}
              <li class="page-item active">    <span class="page-link">
                    {{ i }}
                    <span class="sr-only">(current)</span>
                  </span>
                </li>
            {% else %}
              <li class="page-item"><a class="page-link" href="?page={{ i }}">{{ i }}&nbsp;</a></li>
            {% endif %}
          {% endfor %}
          {% if events.has_next %}
            <li class="page-item"><a class="page-link" href="?page={{ events.next_page_number }}">Next</a></li>
          {% else %}
            <li class="page-item disabled"><span>Next</span></li>
          {% endif %}
        </ul>
      {% endif %}

    </div>
  </div>
</div>

{% endblock %}

{% block footer %}

<script src="{% static "assets/js/plugins/sweetalert2.js" %}"></script>

<script>
$( document ).ready(function() {
  if(window.performance.navigation.type === 2) {
     // the page was navigated to via the forward or back button
     // refresh to make sure auto top up status is correct
     location.reload();
  }
});

// change to auto top up toggle
  $(function() {
    $('#auto-button').change(function() {
      if ($(this).prop('checked')) {
        window.location.href = "{% url "payments:setup_autotopup" %}";
      } else {
        window.location.href = "{% url "payments:cancel_autotopup" %}";
      }
    })
  })
</script>

{% endblock %}
