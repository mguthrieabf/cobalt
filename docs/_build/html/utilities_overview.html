

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Utilities Overview &mdash; Cobalt 0.0.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> Cobalt
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Cobalt Modules</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="modules.html">cobalt</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Cobalt</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Utilities Overview</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/utilities_overview.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <a class="reference internal image-reference" href="_images/cobalt.jpg" id="forums-overview"><img alt="Cobalt Chemical Symbol" id="forums-overview" src="_images/cobalt.jpg" style="width: 300px;" /></a>
<div class="section" id="utilities-overview">
<h1>Utilities Overview<a class="headerlink" href="#utilities-overview" title="Permalink to this headline">¶</a></h1>
<div class="section" id="generic-user-search">
<h2>Generic User Search<a class="headerlink" href="#generic-user-search" title="Permalink to this headline">¶</a></h2>
<p>This is a client side utility that shows a pop up box for the user to search
for another user. In order to implement this you need to do 4 things:</p>
<ol class="arabic">
<li><p>Import the body part of the HTML into your template:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="o">%</span> <span class="n">include</span> <span class="s2">&quot;generic_user_search_body.html&quot;</span> <span class="o">%</span><span class="p">}</span>
</pre></div>
</div>
</li>
<li><p>Set up a button or similar HTML element to trigger the search:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">a</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;cobalt_generic_member&quot;</span> <span class="n">data</span><span class="o">-</span><span class="n">toggle</span><span class="o">=</span><span class="s2">&quot;modal&quot;</span> <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;unique_id&quot;</span> <span class="n">data</span><span class="o">-</span><span class="n">target</span><span class="o">=</span><span class="s2">&quot;#cobalt_general_member_search&quot;</span><span class="o">&gt;</span><span class="n">Add</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
</pre></div>
</div>
</li>
<li><p>Import the footer part of the HTML into your template:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="o">%</span> <span class="n">block</span> <span class="n">footer</span> <span class="o">%</span><span class="p">}</span>
<span class="o">&lt;</span><span class="n">script</span><span class="o">&gt;</span>
<span class="p">{</span><span class="o">%</span> <span class="n">include</span> <span class="s1">&#39;generic_user_search_footer.html&#39;</span> <span class="o">%</span><span class="p">}</span>
</pre></div>
</div>
</li>
<li><p>Below the block footer, set up a function to handle a user selecting another member from the list. This also needs to clear the form:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="n">cobaltMemberSearchOk</span><span class="p">()</span> <span class="p">{</span>
<span class="o">//</span> <span class="n">clear</span> <span class="n">the</span> <span class="n">form</span>
  <span class="n">clearModal</span><span class="p">();</span>

<span class="o">//</span> <span class="n">Do</span> <span class="n">whatever</span>
<span class="n">alert</span><span class="p">(</span><span class="n">member_id</span><span class="p">);</span>

<span class="o">&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
<span class="p">{</span><span class="o">%</span> <span class="n">endblock</span> <span class="o">%</span><span class="p">}</span>
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="pagination-footer">
<h2>Pagination Footer<a class="headerlink" href="#pagination-footer" title="Permalink to this headline">¶</a></h2>
<p>To use the same pagination footer (Next Page, Previous Page, etc at the bottom of a screen that is too big to show everything on one page.),
you can use:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="o">%</span> <span class="n">include</span> <span class="s1">&#39;pagination_footer.html&#39;</span> <span class="o">%</span><span class="p">}</span>
</pre></div>
</div>
<p>Your list must be called ‘things’ for this to work.</p>
<p>If you are paginating over a search list you will need to supply your search string as well. e.g.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;author&quot;</span><span class="p">)</span>
<span class="n">title</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">)</span>
<span class="n">forum</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;forum&quot;</span><span class="p">)</span>
<span class="n">searchparams</span> <span class="o">=</span> <span class="s2">&quot;author=</span><span class="si">%s</span><span class="s2">&amp;title=</span><span class="si">%s</span><span class="s2">&amp;forum=</span><span class="si">%s</span><span class="s2">&amp;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">forum</span><span class="p">)</span>

<span class="k">return</span> <span class="n">render</span><span class="p">(</span>
    <span class="n">request</span><span class="p">,</span>
    <span class="s2">&quot;forums/post_search.html&quot;</span><span class="p">,</span>
    <span class="p">{</span><span class="s2">&quot;filter&quot;</span><span class="p">:</span> <span class="n">post_filter</span><span class="p">,</span> <span class="s2">&quot;things&quot;</span><span class="p">:</span> <span class="n">response</span><span class="p">,</span> <span class="s2">&quot;searchparams&quot;</span><span class="p">:</span> <span class="n">searchparams</span><span class="p">},</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="pagination-formatter">
<h2>Pagination Formatter<a class="headerlink" href="#pagination-formatter" title="Permalink to this headline">¶</a></h2>
<p>Pagination in views is a common thing so we have a central utility for it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">cobalt.utils</span> <span class="kn">import</span> <span class="n">cobalt_paginator</span>

<span class="n">my_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;some&quot;</span><span class="p">,</span> <span class="s2">&quot;list&quot;</span><span class="p">,</span> <span class="s2">&quot;to&quot;</span><span class="p">,</span> <span class="s2">&quot;paginate&quot;</span><span class="p">]</span>
<span class="n">items_per_page</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">things</span> <span class="o">=</span> <span class="n">cobalt_paginator</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">my_list</span><span class="p">,</span> <span class="n">items_per_page</span><span class="p">)</span>
<span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;mypage.html&quot;</span> <span class="p">{</span><span class="s2">&quot;things&quot;</span><span class="p">:</span> <span class="n">things</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="section" id="unsaved-changes">
<h2>Unsaved Changes<a class="headerlink" href="#unsaved-changes" title="Permalink to this headline">¶</a></h2>
<p>Lots of forms need to handle users navigating away from the page without saving
changes. We have a JavaScript function to handle this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">script</span> <span class="n">src</span><span class="o">=</span><span class="s2">&quot;{</span><span class="si">% s</span><span class="s2">tatic &quot;</span><span class="n">assets</span><span class="o">/</span><span class="n">js</span><span class="o">/</span><span class="n">cobalt</span><span class="o">-</span><span class="n">unsaved</span><span class="o">.</span><span class="n">js</span><span class="s2">&quot; %}&quot;</span><span class="o">&gt;&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>You also need to identify which buttons are <em>save</em> buttons and should be
ignored if pressed (i.e. don’t warn the user about navigating away with unsaved
changes). Do this using the class cobalt-save:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">button</span> <span class="nb">type</span><span class="o">=</span><span class="s2">&quot;submit&quot;</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Save&quot;</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;cobalt-save btn btn-success&quot;</span><span class="o">&gt;</span><span class="n">Save</span><span class="o">&lt;/</span><span class="n">button</span><span class="o">&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="template-filters">
<h2>Template Filters<a class="headerlink" href="#template-filters" title="Permalink to this headline">¶</a></h2>
<p>You can use the following template filters:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="o">%</span> <span class="n">load</span> <span class="n">cobalt_tags</span> <span class="o">%</span><span class="p">}</span>

    <span class="p">{{</span> <span class="n">my_date_or_datetime</span><span class="o">|</span><span class="n">cobalt_nice_date</span> <span class="p">}}</span>

    <span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span> <span class="n">Saturday</span> <span class="mi">7</span><span class="n">th</span> <span class="n">May</span> <span class="mi">2022</span>

    <span class="p">{{</span> <span class="n">my_time_or_datetime</span><span class="o">|</span><span class="n">cobalt_time</span> <span class="p">}}</span>

    <span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span> <span class="mi">10</span><span class="n">am</span> <span class="ow">or</span> <span class="mi">7</span><span class="p">:</span><span class="mi">35</span><span class="n">pm</span>

    <span class="p">{{</span> <span class="n">my_datetime</span><span class="o">|</span><span class="n">cobalt_nice_datetime</span> <span class="p">}}</span>

    <span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span> <span class="n">Saturday</span> <span class="mi">7</span><span class="n">th</span> <span class="n">May</span> <span class="mi">2022</span> <span class="mi">11</span><span class="p">:</span><span class="mi">32</span><span class="n">am</span>

    <span class="p">{{</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">|</span><span class="n">cobalt_user_link</span> <span class="p">}}</span>

    <span class="n">prints</span> <span class="n">user</span> <span class="k">with</span> <span class="n">a</span> <span class="n">link</span> <span class="n">to</span> <span class="n">their</span> <span class="n">public</span> <span class="n">profile</span><span class="o">.</span> <span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span>
        <span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s1">&#39;/accounts/public_profile/45&#39;</span><span class="o">&gt;</span><span class="n">Peter</span> <span class="n">Parker</span><span class="p">(</span><span class="mi">45654</span><span class="p">)</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="batch-jobs">
<h1>Batch Jobs<a class="headerlink" href="#batch-jobs" title="Permalink to this headline">¶</a></h1>
<p>Cobalt uses django-extensions
<a class="reference external" href="https://django-extensions.readthedocs.io/en/latest/jobs_scheduling.html">django-extensions</a>.
to handle batch jobs. This allows us to have batch jobs defined within the applications
to which they correspond.</p>
<p>Django-extensions creates a structure for us, e.g.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cobalt</span>\
      <span class="n">events</span>\
            <span class="n">jobs</span>\
              <span class="n">hourly</span>\
                <span class="n">hourly_job_1</span><span class="o">.</span><span class="n">py</span>
                <span class="n">hourly_job_2</span><span class="o">.</span><span class="n">py</span>
              <span class="n">daily</span>\
                <span class="n">my_daily_job</span><span class="o">.</span><span class="n">py</span>
              <span class="n">weekly</span>\
              <span class="n">monthly</span>\
              <span class="n">yearly</span>\
</pre></div>
</div>
<p>You can follow the examples to create new jobs.</p>
<div class="section" id="multi-node-environments">
<h2>Multi-Node Environments<a class="headerlink" href="#multi-node-environments" title="Permalink to this headline">¶</a></h2>
<p>We generally only want the batch to run once so in a multi-node environment
such as AWS we need to make sure the batch doesn’t run on all nodes. We can
do this with a Cobalt utility:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">utils.views</span> <span class="kn">import</span> <span class="n">CobaltBatch</span>
<span class="kn">from</span> <span class="nn">django_extensions.management.jobs</span> <span class="kn">import</span> <span class="n">DailyJob</span>

<span class="k">class</span> <span class="nc">Job</span><span class="p">(</span><span class="n">DailyJob</span><span class="p">):</span>
    <span class="n">help</span> <span class="o">=</span> <span class="s2">&quot;Cache (db) cleanup Job&quot;</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

      <span class="n">batch</span> <span class="o">=</span> <span class="n">CobaltBatch</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;My batch run&quot;</span><span class="p">,</span> <span class="n">instance</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">schedule</span><span class="o">=</span><span class="s2">&quot;Hourly&quot;</span> <span class="n">rerun</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="c1"># instance is optional and only needed if you run multiple times per day</span>

      <span class="k">if</span> <span class="n">batch</span><span class="o">.</span><span class="n">start</span><span class="p">():</span>

<span class="c1"># run your commands</span>

        <span class="n">batch</span><span class="o">.</span><span class="n">finished</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s2">&quot;Success&quot;</span><span class="p">)</span>
<span class="c1">#        batch.finished(status=&quot;Failed&quot;)</span>
</pre></div>
</div>
<p>As well as recording the start and end times of the batch job, CobaltBatch
ensures that only one job per day per instance can be run. It does this by
sleeping for a random time to avoid conflict and returning false for any
subsequent job that tries to start. You can override this by specifying
rerun=True (I don’t know how yet!).</p>
</div>
<div class="section" id="running-batch-jobs">
<h2>Running Batch Jobs<a class="headerlink" href="#running-batch-jobs" title="Permalink to this headline">¶</a></h2>
<p>You need to run batch jobs from cron:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">runjobs</span> <span class="n">daily</span>
</pre></div>
</div>
<p>For Elastic Beanstalk this can be set up with an install script.</p>
</div>
</div>
<div class="section" id="aws-utilities">
<h1>AWS Utilities<a class="headerlink" href="#aws-utilities" title="Permalink to this headline">¶</a></h1>
<p>These are specific to the ABF implementation of Cobalt but can be modified
for use on any other installation that uses AWS Elastic Beanstalk.</p>
<p>These commands also rely upon the configuration files and scripts that live in
<code class="docutils literal notranslate"><span class="pre">.ebextensions</span></code> and <code class="docutils literal notranslate"><span class="pre">.platform</span></code>.</p>
<div class="section" id="cobalt-aws-create-environment-py">
<h2>cobalt_aws_create_environment.py<a class="headerlink" href="#cobalt-aws-create-environment-py" title="Permalink to this headline">¶</a></h2>
<p>Creates a new Elastic Beanstalk environment including DNS entries. This requires
a config file with the environment variables which for obvious security reasons
is not kept within Github.</p>
<p>For usage run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">cobalt_aws_create_environment</span><span class="o">.</span><span class="n">py</span> <span class="o">-</span><span class="n">h</span>
</pre></div>
</div>
<p>For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">cobalt_aws_create_environment</span><span class="o">.</span><span class="n">py</span> <span class="n">cobalt</span><span class="o">-</span><span class="n">uat</span><span class="o">-</span><span class="n">pink</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">cobalt</span><span class="o">-</span><span class="n">uat</span><span class="o">.</span><span class="n">env</span> <span class="o">--</span><span class="n">env_type</span> <span class="n">uat</span> <span class="o">-</span><span class="n">d</span> <span class="n">uat3</span>

<span class="n">EB</span> <span class="n">Environment</span> <span class="n">Name</span><span class="p">:</span> <span class="n">cobalt</span><span class="o">-</span><span class="n">uat</span><span class="o">-</span><span class="n">pink</span>
<span class="n">Input</span> <span class="n">config</span> <span class="n">file</span><span class="p">:</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">cobalt</span><span class="o">-</span><span class="n">uat</span><span class="o">.</span><span class="n">env</span>
<span class="n">Environment</span> <span class="nb">type</span><span class="p">:</span> <span class="n">UAT</span>
<span class="n">DNS</span> <span class="n">name</span><span class="p">:</span> <span class="n">uat3</span><span class="o">.</span><span class="n">abftech</span><span class="o">.</span><span class="n">com</span><span class="o">.</span><span class="n">au</span>
</pre></div>
</div>
<p>The most useful option is <code class="docutils literal notranslate"><span class="pre">--env_type</span> <span class="pre">standalone</span></code> which creates an environment
with a local sqlite3 database. This won’t interfere with any other environment and
can be used for specific testing. Note that creating a test or uat environment will
replace the existing data in those databases with the default test data.</p>
<p>This script uses ssh to connect to the instance to complete set up. This is only
intended for single node clusters and is not used for production systems which
must set up their own environments. As ssh is used you will be prompted to
confirm the first time connection. You can remove this check (not recommended
unless you are okay with no server checking which can allow a man-in-the-middle
attack) by adding this to your .ssh/config:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Host</span> <span class="o">*</span>
 <span class="n">StrictHostKeyChecking</span> <span class="n">no</span>
 <span class="n">UserKnownHostsFile</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, ABF

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>